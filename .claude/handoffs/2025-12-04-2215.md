# Handoff - linux-settings (kdub.settings)
**Date:** 2025-12-04 22:15 | **Branch:** master

## Summary
Major refactoring of dotfiles manager to support multi-platform (linux-amd64, linux-arm64, darwin) architecture with profiles, new module interface, dry-run mode, and logging. Core implementation complete for linux-amd64, but discovered critical bugs during testing: module install failures cause script to exit before configuring shell, and gemini module has placeholder package name.

## Completed
- Removed orphaned files: `install.sh`, `lib/config.sh`, `lib/installers.sh`, empty config templates, fish shell support
- Enhanced `lib/common.sh` with:
  - Platform/arch detection (`detect_platform_arch()`)
  - Logging to `~/.config/kdub.settings.log`
  - Interactive config merge (`interactive_merge()`)
  - `prompt_choice()` for numbered selections
  - Dry-run support (`would_do()`)
- Refactored `setup.sh` with new flow:
  - `--profile=NAME`, `--dry-run`, `--update`, `--debug` flags
  - Associative arrays for module storage
  - Module sourcing reduced from 5-6x to max 2x per module
- Moved modules to `modules/linux-amd64/` directory
- Updated all 20 modules to new interface: `module_check()`, `module_install()`, `module_update()`, `module_config()`
- Created system module: `modules/linux-amd64/_system/op.sh` (1Password CLI)
- Created profiles: `profiles/desktop.sh`, `profiles/server.sh`, `profiles/work.sh`
- Created `ROADMAP.md` for tracking future work
- Fixed `debug()` function causing early exit with `set -e`

## In Progress
- **Bug: Script exits on module install failure** - When a module's `module_install()` fails (e.g., gemini), `set -e` causes the entire script to exit before reaching `configure_shell()`. User suggested running each module fully in one iteration instead of separate phases.
- **Bug: Aliases not installed for successful modules** - Related to above; script exits before config generation.

## Key Decisions
- **Full module duplication per platform** - User chose this over shared modules with overrides for simplicity. Each platform (linux-amd64, linux-arm64, darwin) has its own complete module directory.
- **Profiles are independent lists** - Not additive/subtractive; each profile defines exactly which modules to install.
- **Git assumed installed** - No system module for git since it's required to clone the repo. The git.sh module only adds aliases.
- **Interactive config merge** - When config files exist, prompt per-file with options: interactive merge (function-by-function), replace entirely, or skip.
- **Project renamed** - From "castle.lan" to "kdub.settings"

## Insights & Patterns
- **Bash `set -e` gotcha**: Functions like `$DEBUG && echo ...` return exit code 1 when DEBUG=false, causing script to exit. Fixed with `|| true`.
- **Module interface**: Each module defines `MODULE_NAME`, `MODULE_DESCRIPTION`, `module_check()`, `module_install()`, `module_update()`, `module_config()`, `module_aliases()`, `module_functions()`, `module_env()`, `module_paths()`.
- **Ubuntu package naming**: bat→batcat, fd→fdfind require symlinks in `~/.local/bin/`.

## Blocked
- **Gemini module**: Package `@anthropic-ai/gemini-cli` doesn't exist (placeholder). Needs correct Google Gemini CLI installation method.
- **Module failure resilience**: Script architecture needs revision to continue after individual module failures.

## Next Steps
1. **Fix module failure handling** - User wants each module processed fully in one iteration (load→install→capture outputs→config) rather than separate phases. This prevents failures from blocking config generation.
2. **Fix gemini.sh** - Either find correct package name for Google's Gemini CLI or remove/disable the module.
3. **Test full install** - After fixing above, run actual install to verify aliases are configured.
4. **linux-arm64 modules** - Copy from linux-amd64, adjust arch-specific downloads (delta, lazygit, lazydocker, bun).
5. **darwin modules** - Create brew-based versions for macOS.

## Working Context
- **Key files:**
  - `setup.sh` - Main entry point
  - `lib/common.sh` - Shared helpers
  - `modules/linux-amd64/*.sh` - Linux x86_64 modules
  - `modules/linux-amd64/_system/op.sh` - 1Password CLI
  - `profiles/*.sh` - Profile definitions
  - `ROADMAP.md` - Future work tracking
- **Conventions:**
  - Module naming: `modulename.sh`
  - System modules in `_system/` subdirectory
  - Profile naming: `profilename.sh`
- **Commands:**
  - `./setup.sh --dry-run --zsh` - Preview what would install
  - `./setup.sh --dry-run --zsh --profile=server` - Preview with profile
  - `./setup.sh --zsh` - Interactive install
  - `./setup.sh --profile=desktop --zsh` - Non-interactive profile install

## Memories to Store
(MCP not available - manually document for later storage)

1. **decision**: Kevin chose full module duplication per platform (linux-amd64, linux-arm64, darwin) over shared modules with overrides for simplicity in linux-settings. Future Windows support would add modules/windows/.

2. **decision**: In linux-settings profiles, each profile is an independent list of modules (not additive). Running with --profile=X installs exactly those modules non-interactively.

3. **implementation**: linux-settings uses associative arrays to store module data (MODULE_FILES, MODULE_ALIASES, etc.) keyed by MODULE_NAME. Modules sourced max 2x: once for metadata, once for install if needed.

4. **blocker**: linux-settings setup.sh exits on any module install failure due to set -e, preventing shell config generation. User wants each module fully processed in one iteration instead of separate load/install/config phases.

5. **blocker**: gemini.sh module in linux-settings has placeholder package @anthropic-ai/gemini-cli which doesn't exist. Needs correct Google Gemini CLI installation.

6. **insight**: In bash with set -e, expressions like `$DEBUG && echo ...` return exit 1 when DEBUG=false, causing script exit. Fix with `|| true`.

7. **context**: linux-settings (kdub.settings) is Kevin's personal dotfiles manager supporting linux-amd64, linux-arm64, darwin. Uses modular architecture with profiles for different machine types (desktop, server, work).

8. **next-step**: Refactor setup.sh to process each module fully in one iteration (load→check→install→capture outputs→config) to prevent failures from blocking shell configuration.
